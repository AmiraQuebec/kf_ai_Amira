name: CI (legacy node6)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  legacy_smoke:
    runs-on: ubuntu-latest
    container:
      image: node:6.17.1

    steps:
      - name: Install git (if missing)
        run: |
          command -v git >/dev/null 2>&1 || (apt-get update && apt-get install -y git ca-certificates)

      - name: Checkout with git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git repo
          cd repo
          git checkout ${GITHUB_SHA}

      - name: Install dependencies (npm install)
        run: |
          cd repo
          rm -rf node_modules
          rm -rf ~/.npm
          npm config set cache /tmp/.npm
          npm config set unsafe-perm true
          npm cache clean || true
          npm install --no-audit --no-fund || (echo "---- npm-debug.log (tail) ----" && tail -n 200 npm-debug.log && exit 1)



          git status --porcelain
          ls -la

      - name: Versions
        run: |
          node -v
          npm -v

