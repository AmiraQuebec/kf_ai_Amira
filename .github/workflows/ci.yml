name: CI

on:
  push:
  pull_request:

jobs:
  legacy_full:
    name: legacy node6 full install (dev) + test/build
    runs-on: ubuntu-latest
    container: node:6.17.1

    steps:
      # IMPORTANT: pas de actions/checkout ici (problème glibc)
      - name: Git clone
        run: |
          apt-get update -y && apt-get install -y git ca-certificates
          git clone --depth 1 --branch "${GITHUB_REF_NAME:-main}" "https://github.com/${GITHUB_REPOSITORY}.git" repo
          cd repo
          git rev-parse --short HEAD

      - name: Install deps (dev) - hard clean
        run: |
          cd repo
          node -v
          npm -v

          # nettoyage dur
          rm -rf node_modules
          rm -rf /root/.npm/_locks /root/.npm/_tmp /root/.npm/_cacache 2>/dev/null || true
          npm cache clean || true

          # TMP local (évite .staging foireux)
          mkdir -p .tmp
          export TMPDIR="$PWD/.tmp"

          # install complet (inclut devDependencies)
          npm install --no-audit --no-fund --verbose || (
          echo "===== npm install FAILED ====="
          echo "PWD=$(pwd)"
          echo "----- npm-debug.log (tail) -----"
          test -f npm-debug.log && tail -n 200 npm-debug.log || echo "No npm-debug.log found"
          echo "----- ls node_modules/.staging -----"
          ls -la node_modules/.staging 2>/dev/null || true
          exit 1
           )


      - name: Run tests (if any)
        run: |
          cd repo
          # si "test" existe, ça le lance; sinon, ça n'échoue pas
          npm -s run test || echo "No test script (ok)"

      - name: Build (if any)
        run: |
          cd repo
          # pareil pour build
          npm -s run build || echo "No build script (ok)"

